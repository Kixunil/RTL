<div fxLayout="row">
  <div fxFlex="100" class="padding-gap-large">
    <mat-card-header fxLayout="row" fxLayoutAlign="space-between center" class="modal-info-header">
      <div fxFlex="95" fxLayoutAlign="start start">
        <span class="page-title">Connect to a new peer</span>
      </div>
      <button tabindex="8" fxFlex="5" fxLayoutAlign="center" class="btn-close-x p-0" (click)="onClose()" mat-button>X</button>
    </mat-card-header>    
    <mat-card-content class="mt-5px">
      <div fxLayout="column">
        <mat-vertical-stepper [linear]="true" #stepper (selectionChange)="stepSelectionChanged($event)">
          <mat-step [stepControl]="peerFormGroup" [editable]="flgEditable">
            <form [formGroup]="peerFormGroup" fxLayout="column" fxLayout.gt-sm="row wrap" fxLayoutAlign="start" fxLayoutAlign.gt-sm="space-between" class="my-1">
              <ng-template matStepLabel>{{peerFormLabel}}</ng-template>              
              <mat-form-field fxFlex="100">
                <input autoFocus matInput placeholder="Lightning Address (pubkey OR pubkey@ip:port)" formControlName="peerAddress" tabindex="1" required>
                <mat-error *ngIf="peerFormGroup.controls.peerAddress.errors?.required">Address is required.</mat-error>
              </mat-form-field>
              <div fxFlex="100" class="alert alert-danger" *ngIf="peerConnectionError !== ''">
                <fa-icon [icon]="faExclamationTriangle" class="mr-1 alert-icon"></fa-icon>
                <span>{{peerConnectionError}}</span>
              </div>
              <div class="mt-2" fxLayout="row" fxLayoutAlign="start center" fxFlex="100">
                <button mat-stroked-button color="primary" tabindex="3" type="button" (click)="onConnectPeer()">Add Peer</button>
              </div>
            </form>
          </mat-step>
          <mat-step [stepControl]="channelFormGroup" [editable]="flgEditable">
            <form [formGroup]="channelFormGroup" fxLayout="column" fxLayout.gt-sm="row wrap" fxLayoutAlign="start" fxLayoutAlign.gt-sm="space-between" class="my-1">
              <ng-template matStepLabel disabled="true">{{channelFormLabel}}</ng-template>
              <div fxLayout="column" fxLayout.gt-sm="row wrap" fxFlex="100" fxLayoutAlign="space-between stretch">
                <div fxLayout="row" fxFlex="100" fxLayoutAlign="space-between center" class="mt-1">
                  <mat-form-field fxFlex="60" fxLayoutAlign="start end">
                    <input matInput formControlName="fundingAmount" placeholder="Amount {{totalBalance}} {{channelFormGroup.controls.fundingAmount.value}}" type="number" step="1000" tabindex="1" required>
                    <mat-hint>HINT</mat-hint>
                    <mat-hint>Remaining Bal: {{totalBalance - ((channelFormGroup.controls.fundingAmount.value) ? channelFormGroup.controls.fundingAmount.value : 0)}}</mat-hint>
                    <span matSuffix> Sats </span>
                    <mat-error *ngIf="channelFormGroup.controls.fundingAmount.errors?.required">Amount is required.</mat-error>
                    <mat-error *ngIf="channelFormGroup.controls.fundingAmount.errors?.min">Amount must be a positive number.</mat-error>
                    <mat-error *ngIf="channelFormGroup.controls.fundingAmount.errors?.max">Amount must be less than or equal to {{totalBalance}}.</mat-error>
                  </mat-form-field>
                  <div fxFlex="35" fxLayoutAlign="start center">
                    <mat-slide-toggle tabindex="2" color="primary" formControlName="isPrivate" name="isPrivate">Private Channel</mat-slide-toggle>
                  </div>
                </div>
                <div fxLayout="row" fxFlex="100" fxLayoutAlign="space-between center">
                  <mat-form-field fxFlex="30" fxLayoutAlign="start end">
                    <mat-select tabindex="3" formControlName="selTransType" placeholder="Transaction Type">
                      <mat-option *ngFor="let transType of transTypes" [value]="transType.id">
                        {{transType.name}}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                  <mat-form-field fxFlex="30">
                    <input matInput formControlName="transTypeValue" [placeholder]="channelFormGroup.controls.selTransType.value == '0' ? 'Default' : channelFormGroup.controls.selTransType.value == '1' ? 'Target Confirmation Blocks' : 'Fee (Sats/Byte)'" type="number" name="transTypeValue" step="1" tabindex="4">
                    <mat-error *ngIf="channelFormGroup.controls.selTransType.errors?.required">{{channelFormGroup.controls.selTransType.value == '0' ? 'Default' : channelFormGroup.controls.selTransType.value == '1' ? 'Target Confirmation Blocks' : 'Fee (Sats/Byte)'}} is required.</mat-error>
                  </mat-form-field>
                  <div fxFlex="35" fxLayoutAlign="start center">
                    <mat-slide-toggle tabindex="6" color="primary" formControlName="spendUnconfirmed" name="spendUnconfirmed">Spend Unconfirmed Output</mat-slide-toggle>
                  </div>
                </div>
              </div>
              <div class="mt-2" fxLayout="row" fxLayoutAlign="start center" fxFlex="100">
                <button mat-stroked-button color="primary" tabindex="8" type="button" (click)="onOpenChannel()">Open Channel</button>
              </div>
            </form>
          </mat-step>
          <mat-step [stepControl]="statusFormGroup">
            <form [formGroup]="statusFormGroup" fxLayout="column" fxLayout.gt-sm="row wrap" fxLayoutAlign="start" fxLayoutAlign.gt-sm="space-between" class="my-1">
              <ng-template matStepLabel>Channel Status</ng-template>
              <div fxLayout="row wrap" fxFlex="100" fxLayoutAlign="space-between stretch">
                <mat-expansion-panel class="flat-expansion-panel" fxFlex="100" [expanded]="true">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <span fxLayoutAlign="start center" fxFlex="100">{{!flgChannelOpened ? 'Opening channel' : 'Channel opened'}}<mat-icon *ngIf="flgChannelOpened" class="ml-1 icon-small">{{channelOpenStatus?.error ? 'close' : 'check'}}</mat-icon></span>
                    </mat-panel-title>
                  </mat-expansion-panel-header>
                  <div fxLayout="column" *ngIf="!channelOpenStatus; else channelOpenStatusBlock"></div>
                </mat-expansion-panel>
                <mat-progress-bar fxFlex="100" *ngIf="flgChannelOpened" color="primary" mode="indeterminate"></mat-progress-bar>
              </div>
              <h4 *ngIf="flgChannelOpened" fxLayoutAlign="start" class="font-bold-500 mt-1">{{channelOpenStatus && channelOpenStatus.chan_id ? 'Open Channel Successful.' : 'Open Channel Failed.'}}</h4>
              <div class="mt-1" fxLayout="row" fxLayoutAlign="start center" fxFlex="100">
                <button *ngIf="channelOpenStatus && channelOpenStatus.error" mat-flat-button color="primary" tabindex="11" type="button" (click)="flgChannelOpened=false;stepper.reset()">Start Again</button>
              </div>
            </form>
          </mat-step>
        </mat-vertical-stepper>
        <div fxLayout="row" fxFlex="100" fxLayoutAlign="end center">        
          <button mat-stroked-button color="primary" tabindex="12" type="button" [mat-dialog-close]="false" default>Close</button>
        </div>
      </div>
    </mat-card-content>
  </div>
</div>
<ng-template #channelOpenStatusBlock>
  <ng-container *ngTemplateOutlet="channelOpenStatus.error ? channelFailedBlock : channelSuccessfulBlock"></ng-container>
</ng-template>
<ng-template #channelFailedBlock>
  <div fxLayout="column"><span class="foreground-secondary-text">{{'Error: ' + (channelOpenStatus.error.error.error ? channelOpenStatus.error.error.error : channelOpenStatus.error.error ? channelOpenStatus.error.error : channelOpenStatus.error ? channelOpenStatus.error : 'Unknown')}}</span></div>
</ng-template>
<ng-template #channelSuccessfulBlock>
  <div fxLayout="column">
    <div fxLayout="row">
      <div fxFlex="100">
        <h4 fxLayoutAlign="start" class="font-bold-500">Channel ID</h4>
        <span class="foreground-secondary-text">{{channelOpenStatus.chan_id}}</span>
      </div>
    </div>
    <mat-divider class="w-100 my-1"></mat-divider>        
    <div fxLayout="row">
      <!-- <div fxFlex="50">
        <h4 fxLayoutAlign="start" class="font-bold-500">Total Fees ({{paymentStatus.payment_route.total_fees_msat ? 'mSats' : 'Sats'}})</h4>
        <span class="foreground-secondary-text">{{paymentStatus.payment_route.total_fees_msat ? paymentStatus.payment_route.total_fees_msat : paymentStatus.payment_route.total_fees ? paymentStatus.payment_route.total_fees : 0}}</span>
      </div>
      <div fxFlex="50">
        <h4 fxLayoutAlign="start" class="font-bold-500">Number of Hops</h4>
        <span class="foreground-secondary-text">{{paymentStatus && paymentStatus.payment_route && paymentStatus.payment_route.hops && paymentStatus.payment_route.hops.length ? paymentStatus.payment_route.hops.length : 0}}</span>
      </div> -->
    </div>
  </div>
</ng-template>
